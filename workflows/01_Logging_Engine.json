{"name": "01_Logging_Engine_Patched_Final", "_comment": "Central logging engine. Receives log payloads and stores them in Google Sheets + internal webhook.", "nodes": [{"id": "Webhook_Trigger", "name": "Receive Log Event", "type": "n8n-nodes-base.webhook", "typeVersion": 1, "parameters": {"path": "logging_engine", "httpMethod": "POST", "responseMode": "onReceived"}}, {"id": "Validate_Input", "name": "Validate Input", "type": "n8n-nodes-base.function", "typeVersion": 1, "_comment": "Validates required fields and severity (low/medium/high/critical).", "parameters": {"functionCode": "\nconst input = items[0].json;\nconst required = ['event_type','workflow','timestamp','success'];\n\nrequired.forEach(f => {\n  if (!input[f]) throw new Error(`Missing required field: ${f}`);\n});\n\nif (input.severity) {\n  const allowed = ['low','medium','high','critical'];\n  if (!allowed.includes(String(input.severity).toLowerCase())) {\n    throw new Error(`Invalid severity: ${input.severity}`);\n  }\n}\n\nreturn items;\n"}}, {"id": "Append_Sheet", "name": "Write to Google Sheets", "type": "n8n-nodes-base.googleSheets", "typeVersion": 3, "parameters": {"operation": "append", "sheetId": "={{$env.GS_LOGGING_SHEET_ID}}", "range": "Sheet1!A:H", "valueInputMode": "RAW", "data": [["={{$json[\"timestamp\"]}}", "={{$json[\"workflow\"]}}", "={{$json[\"event_type\"]}}", "={{$json[\"success\"]}}", "={{$json[\"severity\"]}}", "={{$json[\"actor\"]}}", "={{JSON.stringify($json[\"payload\"] || {})}}", "={{$json[\"error\"]}}"]], "continueOnFail": true}, "credentials": {"googleApi": {"id": "={{$env.GOOGLE_CREDENTIALS_ID}}"}}}, {"id": "Forward_Webhook", "name": "Forward to Internal Webhook", "type": "n8n-nodes-base.httpRequest", "typeVersion": 1, "parameters": {"url": "={{$env.INTERNAL_LOGGING_WEBHOOK}}", "method": "POST", "jsonParameters": true, "continueOnFail": true, "bodyParametersJson": "={{$json}}"}}, {"id": "Respond", "name": "Respond OK", "type": "n8n-nodes-base.respondToWebhook", "typeVersion": 1, "parameters": {"responseBody": "={\"status\":\"logged\"}", "responseCode": 200}}, {"parameters": {"functionCode": "\n// Validate decision token if present\nconst token = $json.decision_token;\nconst expiresAt = $json.token_expires_at;\n\nif (token && expiresAt) {\n  const now = new Date();\n  const expiry = new Date(expiresAt);\n  if (now > expiry) {\n    throw new Error(\"Token expired.\");\n  }\n  return [{ json: { ...$json, token_valid: true } }];\n}\n\nreturn [{ json: { ...$json, token_valid: false } }];\n"}, "name": "Validate Decision Token", "type": "n8n-nodes-base.function", "typeVersion": 1, "position": [600, 300]}, {"parameters": {"functionCode": "\n// Fallback logger \u2014 simulate writing to file or alternate store\nreturn [{\n  json: {\n    ...$json,\n    fallback: true,\n    reason: \"Primary log failed\"\n  }\n}];\n"}, "name": "Log Fallback", "type": "n8n-nodes-base.function", "typeVersion": 1, "position": [850, 300]}], "connections": {"Receive Log Event": {"main": [[{"node": "Validate Input"}]]}, "Validate Input": {"main": [[{"node": "Append_Sheet"}]]}, "Append_Sheet": {"main": [[{"node": "Forward_Webhook"}]]}, "Forward_Webhook": {"main": [[{"node": "Respond"}]]}}}